(()=>{"use strict";(()=>{const t={modes:["net","fake","ai","hotseat","server","match"],mode:"net",debug:!0,wsPort:8088,negotiatedId:3,color:"blue",useSound:!1},e={NONE:0,HIT:1,KILL:2,WIN:3,MISS:4,IMPOSSIBLE_BY_RULES:5},n="абвгдежзиклмнопрст",o=[{len:3,count:1},{len:2,count:2},{len:1,count:3}];function r(t){return t===e.NONE||t>=e.MISS?0:1}function s(t,e){return a(t,e,(()=>{}))}function i(t,n,o){if(!t[o])return e.MISS;const i=s(t,o),l=s(n,o);if(l===i)return function(t,e,n){if(t.length!==e.length)throw"Illegal state";for(let o=0;o<t.length;++o)if(o!==n&&t[o]!==r(e[o]))return!1;return!0}(t,n,o)?e.WIN:e.KILL;if(l<i)return e.HIT;throw"Illegal state"}function l(t,n,o,s){let i=n+o,l=0;for(;i<t.length&&i>=0;){if(!r(t[i])){t[i]===e.NONE&&s(i);break}i+=o,++l}return l}function a(t,e,n){let o=1;return o+=l(t,e,1,n),o+=l(t,e,-1,n),o}const c=["blue","red"];function u(t){for(const e of c)if(t!==e)return e;return""}const h=20;function d(t){return Math.floor((t.offsetX+1)/h)}function f(t,e){e(d(t))}function g(t,e){const o=e.querySelector("#field-template").content.cloneNode(!0),r=o.firstElementChild,s=r.querySelector(".frame-text");for(const t of n){const n=e.createElement("span");n.textContent=t,s.appendChild(n)}return t.appendChild(o).firstElementChild,r}let m=null;function p(t,e,n,o,r){let s=0;const i=r.querySelector(".message");n?i.classList.add("enemy"):i.classList.remove("enemy"),i.textContent="",m&&clearInterval(m),m=setInterval((()=>{s<t.length?(i.textContent+=t.charAt(s),++s):(clearInterval(m),m=setTimeout((()=>{i.textContent=""}),o))}),e)}function y(t){const e=Promise.withResolvers();function r(e){p(e,70,!1,2e3,t)}let s=null,i=0;const l=new Array(n.length).fill(0);const a=[],c=t.querySelector(".grid"),u=g(c,t);u.classList.add("adjust-first");const f=function(t,e){const n=t.createElement("div");return n.classList.add("shipyard"),e.appendChild(n),n}(t,c);function m(e){a.push(function(e){const n=t.createElement("div");return n.classList.add("ship"),n.style.width=e*h+"px",f.appendChild(n),{length:e,html:n}}(e)),++i}for(const t of o)for(let e=0;e<t.count;e++)m(t.len);function y(t,e){s={s:t,n:e};for(const t of a)t.html.classList.remove("choosen");t.html.classList.add("choosen")}for(const t of a)t.html.addEventListener("click",(e=>{e.preventDefault();const n=d(e);y(t,n)}));const w=u.querySelector(".river");function v(){u.classList.remove("adjust-first"),u.classList.add("adjust-third"),w.removeEventListener("click",L)}function C(n){if(n<0)return!1;if(null==s)return r("Выберите корабль"),!1;const o=n-s.n;if(!function(t,e,n){if(!function(t,e,n){if(e<0)return!1;const o=e-1;if(o>=0&&t[o]>0)return!1;for(let o=0;o<n;o++){const n=e+o;if(n>t.length-1)return!1;if(t[n]>0)return!1}const r=e+n;return!(r<t.length&&t[r]>0)}(t,e,n))return!1;for(let o=0;o<n;o++)t[e+o]=1;return--i,!0}(l,o,s.s.length))return r("Тесно!"),!1;const a=t.createElement("div");return a.classList.add("ship-river"),a.classList.add("diagonal-line"),a.style.width=s.s.html.style.width,a.style.left=o*h+"px",w.appendChild(a),s.s.html.classList.add("disabled"),s=null,0===i&&e.resolve({field:l,onOpponentReady:v}),!0}function L(t){t.preventDefault();C(d(t))}return w.addEventListener("click",L),{myFieldPromise:e.promise,putShip:C,ships:a,choose:y}}function w(t,e){return function(t,e,n,o){return e||("https:"!==t?"ws://"+n+":"+o.wsPort:void 0)}(t.protocol,e.wh,t.hostname,e)}function v(t,e){return e.sh||t.origin}let C=null,L="",b="",E=null;function S(t){}const k={recv:S,open:S,socket_open:S,socket_close:S,server_message:S,socket_error:S};let D=null,B=!1;function M(t){const e=new RTCPeerConnection;return e.onicecandidate=function(n){e&&n&&n.candidate&&P("candidate",n.candidate,t)},D=e.createDataChannel("my channel",{negotiated:!0,id:E.negotiatedId}),D.onmessage=function(t){k.recv(t.data)},D.onopen=function(){B=!0,P("close",{},t),k.socket_error=S,t.close(),k.open()},D.onclose=function(){B=!1},D.onerror=function(){},e}function P(t,e,n){const o={from:L,to:b,action:t,data:e};return n.send(JSON.stringify(o))}const _={connect:function(t,e,n,o){E=o,C=new WebSocket(t);let r=null;const s=!e||!n;function i(t){const e=JSON.parse(t);e.from!==L&&(s?k.server_message(t):"candidate"===e.action?function(t,e){e.addIceCandidate(new RTCIceCandidate(t)).catch((t=>{}))}(e.data,r):"offer"===e.action?r=function(t){const e=M(C);return e.setRemoteDescription(t).then((()=>e.createAnswer())).then((t=>e.setLocalDescription(t))).then((()=>P("answer",e.localDescription,C))).catch((t=>{})),e}(e.data):"answer"===e.action?function(t,e){e.setRemoteDescription(new RTCSessionDescription(t))}(e.data,r):"connected"===e.action?r=function(){const t=M(C),e={offerToReceiveAudio:!1,offerToReceiveVideo:!1};return t.createOffer(e).then((e=>t.setLocalDescription(e))).then((()=>{P("offer",t.localDescription,C)})).catch((t=>{})),t}():e.action)}C.onopen=function(t){k.socket_open(),s||(L=e,b=n,P("connected",{color:L},C))},C.onclose=function(t){k.socket_close()},C.onmessage=function(t){if(t.data instanceof Blob){const e=new FileReader;e.onload=()=>{i(e.result)},e.readAsText(t.data)}else i(t.data)},C.onerror=function(e){k.socket_error("url "+t)}},sendMessage:function(t){return!!D&&(!!B&&(D.send(t),B))},on:function(t,e){k[t]=e}};var I=1,A=2,N=4,x=8,q=class{mode;data;constructor(t){this.mode=N,this.data=t}getLength(){return this.data.length}write(t){for(let e=0;e<this.data.length;e++)t.put(this.data.charCodeAt(e),8)}},T={L:1,M:0,Q:3,H:2},R=class t{totalCount;dataCount;constructor(t,e){this.totalCount=t,this.dataCount=e}static RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]];static getRSBlocks(e,n){const o=t.getRsBlockTable(e,n);if(null==o)throw new Error("bad rs block @ typeNumber:"+e+"/errorCorrectLevel:"+n);const r=o.length/3,s=[];for(let e=0;e<r;e++){const n=o[3*e+0],r=o[3*e+1],i=o[3*e+2];for(let e=0;e<n;e++)s.push(new t(r,i))}return s}static getRsBlockTable(e,n){switch(n){case T.L:return t.RS_BLOCK_TABLE[4*(e-1)+0];case T.M:return t.RS_BLOCK_TABLE[4*(e-1)+1];case T.Q:return t.RS_BLOCK_TABLE[4*(e-1)+2];case T.H:return t.RS_BLOCK_TABLE[4*(e-1)+3];default:return}}},O=class{buffer;length;constructor(){this.buffer=[],this.length=0}get(t){const e=Math.floor(t/8);return 1==(this.buffer[e]>>>7-t%8&1)}put(t,e){for(let n=0;n<e;n++)this.putBit(1==(t>>>e-n-1&1))}getLengthInBits(){return this.length}putBit(t){const e=Math.floor(this.length/8);this.buffer.length<=e&&this.buffer.push(0),t&&(this.buffer[e]|=128>>>this.length%8),this.length++}},$={glog:function(t){if(t<1)throw new Error("glog("+t+")");return $.LOG_TABLE[t]},gexp:function(t){for(;t<0;)t+=255;for(;t>=256;)t-=255;return $.EXP_TABLE[t]},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)};for(let t=0;t<8;t++)$.EXP_TABLE[t]=1<<t;for(let t=8;t<256;t++)$.EXP_TABLE[t]=$.EXP_TABLE[t-4]^$.EXP_TABLE[t-5]^$.EXP_TABLE[t-6]^$.EXP_TABLE[t-8];for(let t=0;t<255;t++)$.LOG_TABLE[$.EXP_TABLE[t]]=t;var F=$,H=class t{num;constructor(t,e){if(null==t.length)throw new Error(t.length+"/"+e);let n=0;for(;n<t.length&&0==t[n];)n++;this.num=new Array(t.length-n+e);for(let e=0;e<t.length-n;e++)this.num[e]=t[e+n]}get(t){return this.num[t]}getLength(){return this.num.length}multiply(e){const n=new Array(this.getLength()+e.getLength()-1);for(let t=0;t<this.getLength();t++)for(let o=0;o<e.getLength();o++)n[t+o]^=F.gexp(F.glog(this.get(t))+F.glog(e.get(o)));return new t(n,0)}mod(e){if(this.getLength()-e.getLength()<0)return this;const n=F.glog(this.get(0))-F.glog(e.get(0)),o=new Array(this.getLength());for(let t=0;t<this.getLength();t++)o[t]=this.get(t);for(let t=0;t<e.getLength();t++)o[t]^=F.gexp(F.glog(e.get(t))+n);return new t(o,0).mod(e)}},G=0,U=1,K=2,z=3,V=4,X=5,j=6,J=7,W={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],G15:1335,G18:7973,G15_MASK:21522,getBCHTypeInfo:function(t){let e=t<<10;for(;W.getBCHDigit(e)-W.getBCHDigit(W.G15)>=0;)e^=W.G15<<W.getBCHDigit(e)-W.getBCHDigit(W.G15);return(t<<10|e)^W.G15_MASK},getBCHTypeNumber:function(t){let e=t<<12;for(;W.getBCHDigit(e)-W.getBCHDigit(W.G18)>=0;)e^=W.G18<<W.getBCHDigit(e)-W.getBCHDigit(W.G18);return t<<12|e},getBCHDigit:function(t){let e=0;for(;0!=t;)e++,t>>>=1;return e},getPatternPosition:function(t){return W.PATTERN_POSITION_TABLE[t-1]},getMask:function(t,e,n){switch(t){case G:return(e+n)%2==0;case U:return e%2==0;case K:return n%3==0;case z:return(e+n)%3==0;case V:return(Math.floor(e/2)+Math.floor(n/3))%2==0;case X:return e*n%2+e*n%3==0;case j:return(e*n%2+e*n%3)%2==0;case J:return(e*n%3+(e+n)%2)%2==0;default:throw new Error("bad maskPattern:"+t)}},getErrorCorrectPolynomial:function(t){let e=new H([1],0);for(let n=0;n<t;n++)e=e.multiply(new H([1,F.gexp(n)],0));return e},getLengthInBits:function(t,e){if(1<=e&&e<10)switch(t){case I:return 10;case A:return 9;case N:case x:return 8;default:throw new Error("mode:"+t)}else if(e<27)switch(t){case I:return 12;case A:return 11;case N:return 16;case x:return 10;default:throw new Error("mode:"+t)}else{if(!(e<41))throw new Error("type:"+e);switch(t){case I:return 14;case A:return 13;case N:return 16;case x:return 12;default:throw new Error("mode:"+t)}}},getLostPoint:function(t){const e=t.getModuleCount();let n=0;for(let o=0;o<e;o++)for(let r=0;r<e;r++){let s=0;const i=t.isDark(o,r);for(let n=-1;n<=1;n++)if(!(o+n<0||e<=o+n))for(let l=-1;l<=1;l++)r+l<0||e<=r+l||0==n&&0==l||i==t.isDark(o+n,r+l)&&s++;s>5&&(n+=3+s-5)}for(let o=0;o<e-1;o++)for(let r=0;r<e-1;r++){let e=0;t.isDark(o,r)&&e++,t.isDark(o+1,r)&&e++,t.isDark(o,r+1)&&e++,t.isDark(o+1,r+1)&&e++,0!=e&&4!=e||(n+=3)}for(let o=0;o<e;o++)for(let r=0;r<e-6;r++)t.isDark(o,r)&&!t.isDark(o,r+1)&&t.isDark(o,r+2)&&t.isDark(o,r+3)&&t.isDark(o,r+4)&&!t.isDark(o,r+5)&&t.isDark(o,r+6)&&(n+=40);for(let o=0;o<e;o++)for(let r=0;r<e-6;r++)t.isDark(r,o)&&!t.isDark(r+1,o)&&t.isDark(r+2,o)&&t.isDark(r+3,o)&&t.isDark(r+4,o)&&!t.isDark(r+5,o)&&t.isDark(r+6,o)&&(n+=40);let o=0;for(let n=0;n<e;n++)for(let r=0;r<e;r++)t.isDark(r,n)&&o++;return n+=10*(Math.abs(100*o/e/e-50)/5),n}},Q=W,Y=class t{typeNumber;errorCorrectLevel;modules;moduleCount;dataCache;dataList;constructor(t,e){this.typeNumber=t,this.errorCorrectLevel=e,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}addData(t){const e=new q(t);this.dataList.push(e),this.dataCache=null}isDark(t,e){if(t<0||this.moduleCount<=t||e<0||this.moduleCount<=e)throw new Error(t+","+e);if(null===this.modules)throw new Error("this.modules is null");return this.modules[t][e]}getModuleCount(){return this.moduleCount}make(){if(this.typeNumber<1){let t=1;for(t=1;t<40;t++){const e=R.getRSBlocks(t,this.errorCorrectLevel),n=new O;let o=0;for(let t=0;t<e.length;t++)o+=e[t].dataCount;for(let e=0;e<this.dataList.length;e++){const o=this.dataList[e];n.put(o.mode,4),n.put(o.getLength(),Q.getLengthInBits(o.mode,t)),o.write(n)}if(n.getLengthInBits()<=8*o)break}this.typeNumber=t}this.makeImpl(!1,this.getBestMaskPattern())}makeImpl(e,n){this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(let t=0;t<this.moduleCount;t++){this.modules[t]=new Array(this.moduleCount);for(let e=0;e<this.moduleCount;e++)this.modules[t][e]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(e,n),this.typeNumber>=7&&this.setupTypeNumber(e),null==this.dataCache&&(this.dataCache=t.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),this.mapData(this.dataCache,n)}setupPositionProbePattern(t,e){for(let n=-1;n<=7;n++)if(!(t+n<=-1||this.moduleCount<=t+n))for(let o=-1;o<=7;o++)if(!(e+o<=-1||this.moduleCount<=e+o))if(0<=n&&n<=6&&(0==o||6==o)||0<=o&&o<=6&&(0==n||6==n)||2<=n&&n<=4&&2<=o&&o<=4){if(null===this.modules)throw new Error("this.modules is null");this.modules[t+n][e+o]=!0}else{if(null===this.modules)throw new Error("this.modules is null");this.modules[t+n][e+o]=!1}}getBestMaskPattern(){let t=0,e=0;for(let n=0;n<8;n++){this.makeImpl(!0,n);const o=Q.getLostPoint(this);(0==n||t>o)&&(t=o,e=n)}return e}setupTimingPattern(){if(null===this.modules)throw new Error("this.modules is null");for(let t=8;t<this.moduleCount-8;t++)null==this.modules[t][6]&&(this.modules[t][6]=t%2==0);for(let t=8;t<this.moduleCount-8;t++)null==this.modules[6][t]&&(this.modules[6][t]=t%2==0)}setupPositionAdjustPattern(){if(null===this.modules)throw new Error("this.modules is null");const t=Q.getPatternPosition(this.typeNumber);for(let e=0;e<t.length;e++)for(let n=0;n<t.length;n++){const o=t[e],r=t[n];if(null==this.modules[o][r])for(let t=-2;t<=2;t++)for(let e=-2;e<=2;e++)this.modules[o+t][r+e]=-2==t||2==t||-2==e||2==e||0==t&&0==e}}setupTypeNumber(t){if(null===this.modules)throw new Error("this.modules is null");const e=Q.getBCHTypeNumber(this.typeNumber);for(let n=0;n<18;n++){const o=!t&&1==(e>>n&1);this.modules[Math.floor(n/3)][n%3+this.moduleCount-8-3]=o}for(let n=0;n<18;n++){const o=!t&&1==(e>>n&1);this.modules[n%3+this.moduleCount-8-3][Math.floor(n/3)]=o}}setupTypeInfo(t,e){if(null===this.modules)throw new Error("this.modules is null");const n=this.errorCorrectLevel<<3|e,o=Q.getBCHTypeInfo(n);for(let e=0;e<15;e++){const n=!t&&1==(o>>e&1);e<6?this.modules[e][8]=n:e<8?this.modules[e+1][8]=n:this.modules[this.moduleCount-15+e][8]=n}for(let e=0;e<15;e++){const n=!t&&1==(o>>e&1);e<8?this.modules[8][this.moduleCount-e-1]=n:e<9?this.modules[8][15-e-1+1]=n:this.modules[8][15-e-1]=n}this.modules[this.moduleCount-8][8]=!t}mapData(t,e){if(null===this.modules)throw new Error("this.modules is null");let n=-1,o=this.moduleCount-1,r=7,s=0;for(let i=this.moduleCount-1;i>0;i-=2)for(6==i&&i--;;){for(let n=0;n<2;n++)if(null==this.modules[o][i-n]){let l=!1;s<t.length&&(l=1==(t[s]>>>r&1));Q.getMask(e,o,i-n)&&(l=!l),this.modules[o][i-n]=l,r--,-1==r&&(s++,r=7)}if(o+=n,o<0||this.moduleCount<=o){o-=n,n=-n;break}}}static PAD0=236;static PAD1=17;static createData(e,n,o){const r=R.getRSBlocks(e,n),s=new O;for(let t=0;t<o.length;t++){const n=o[t];s.put(n.mode,4),s.put(n.getLength(),Q.getLengthInBits(n.mode,e)),n.write(s)}let i=0;for(let t=0;t<r.length;t++)i+=r[t].dataCount;if(s.getLengthInBits()>8*i)throw new Error("code length overflow. ("+s.getLengthInBits()+">"+8*i+")");for(s.getLengthInBits()+4<=8*i&&s.put(0,4);s.getLengthInBits()%8!=0;)s.putBit(!1);for(;!(s.getLengthInBits()>=8*i||(s.put(t.PAD0,8),s.getLengthInBits()>=8*i));)s.put(t.PAD1,8);return t.createBytes(s,r)}static createBytes(t,e){let n=0,o=0,r=0;const s=new Array(e.length),i=new Array(e.length);for(let l=0;l<e.length;l++){const a=e[l].dataCount,c=e[l].totalCount-a;o=Math.max(o,a),r=Math.max(r,c),s[l]=new Array(a);for(let e=0;e<s[l].length;e++)s[l][e]=255&t.buffer[e+n];n+=a;const u=Q.getErrorCorrectPolynomial(c),h=new H(s[l],u.getLength()-1).mod(u);i[l]=new Array(u.getLength()-1);for(let t=0;t<i[l].length;t++){const e=t+h.getLength()-i[l].length;i[l][t]=e>=0?h.get(e):0}}let l=0;for(let t=0;t<e.length;t++)l+=e[t].totalCount;const a=new Array(l);let c=0;for(let t=0;t<o;t++)for(let n=0;n<e.length;n++)t<s[n].length&&(a[c++]=s[n][t]);for(let t=0;t<r;t++)for(let n=0;n<e.length;n++)t<i[n].length&&(a[c++]=i[n][t]);return a}};function Z(t,e){if(!t)throw new Error(e)}var tt={level:"L",padding:1,invert:!1,typeNumber:0,errorsEnabled:!1},et=class{value;level;typeNumber;padding;errorsEnabled;invert;qrCodeData;constructor(t,e={}){const n={...tt,...e};this.value=t,this.level=n.level,this.typeNumber=n.typeNumber,this.padding=n.padding,this.invert=n.invert,this.errorsEnabled=n.errorsEnabled}setValue(t){this.value=t,this._clearCache()}getDataSize(){const t=this.getData();return t?t.length:0}_clearCache(){this.qrCodeData=null}_getQrCodeData(t){const e=[],n=this.padding,o=this.invert,r=Array(2*n+t.length).fill(o),s=Array(n).fill(r),i=Array(n).fill(o);return n&&e.push(...s),t.forEach((t=>{const n=[];n.push(...i,...t.map((t=>o?!t:t)),...i),e.push(n)})),n&&e.push(...s),e}getData(){if(!this.qrCodeData)try{const t=new Y(this.typeNumber,T[this.level]);if(t.addData(this.value),t.make(),!t.modules)return null;this.qrCodeData=this._getQrCodeData(t.modules),Object.freeze(this.qrCodeData)}catch(t){if(this.errorsEnabled)throw t;return null}return this.qrCodeData}},nt=class{static calculateDimension(t,e){const n="number"==typeof t;return Z(n||"string"==typeof t,"value must be either string or number, instead got "+typeof t),n?t:t.indexOf("%")>0?Math.round(parseFloat(t)/100*e)||0:parseFloat(t)||0}static calculatePosition(t,e,n){const o="number"==typeof t;if(Z(o||"string"==typeof t,"value must be either string or number, instead got "+typeof t),o)return t;if("left"===t||"top"===t)return 0;if("right"===t||"bottom"===t)return n-e;if("center"===t)return Math.round((n-e)/2);const r=t.match(/^(?:(right|bottom|left|top)\s+)?(-?[0-9.]+)(%)?$/);Z(!!r,`Expected position with number, instead got ${t}`);const s="right"===r[1]||"bottom"===r[1],i=!!r[3];let l=parseFloat(r[2])||0;return i&&(l=Math.round(l/100*n)),s&&(l=n-l-e),Math.round(l)}},ot={image:null},rt=class extends et{image=null;imageConfig=null;constructor(t,e={}){super(t,e);const n={...ot,...e};this.image=n.image}_clearCache(){super._clearCache(),this.imageConfig=null}_getImageSource(t){const e=t.source;return"string"==typeof e?e:e instanceof Image?e.src:e instanceof HTMLCanvasElement?e.toDataURL():null}_getImageConfig(){if(this.imageConfig)return this.imageConfig;if(!(this.image&&this.image.source&&this.image.width&&this.image.height))return null;const t=this.getDataSize();if(!t)return null;const e=this._getImageSource(this.image);if(!e)return null;const n=t-2*this.padding,o=nt.calculateDimension(this.image.width,n),r=nt.calculateDimension(this.image.height,n),s=nt.calculatePosition(this.image.x,o,n)+this.padding,i=nt.calculatePosition(this.image.y,r,n)+this.padding;let l=1;return"number"!=typeof this.image.border&&null!==this.image.border||(l=this.image.border),this.imageConfig={source:e,border:l,x:s,y:i,width:o,height:r},this.imageConfig}getData(){if(this.qrCodeData)return this.qrCodeData;const t=super.getData();if(!t)return t;const e=this._getImageConfig();if(null!==e&&e.width&&e.height&&"number"==typeof e.border){const n=Math.max(e.x-e.border,0),o=Math.max(e.y-e.border,0),r=Math.min(n+e.width+2*e.border,t.length),s=Math.min(o+e.height+2*e.border,t.length);for(let e=o;e<s;e+=1)for(let o=n;o<r;o+=1)t[e][o]=!!this.invert}return t}},st={fgColor:"#000",bgColor:"#FFF"},it=class extends rt{fgColor;bgColor;qrCodeSVG=null;height;width;qrCodeDataUrl=null;constructor(t,e={}){super(t,e);const n={...st,...e};this.fgColor=n.fgColor,this.bgColor=n.bgColor,this.width=n.width,this.height=n.height}_clearCache(){super._clearCache(),this.qrCodeSVG=null,this.qrCodeDataUrl=null}_getDataInt(){const t=this.getData();return t?t.map((t=>t.map((t=>t?1:0)))):null}_getRects(){const t=this._getDataInt();if(!t)return null;const e=[],n=t.length-1;for(let o=0;o<=n;o+=1){let r=-1;for(let s=0;s<=n;s+=1){const i=1===t[o][s];if(i&&-1===r&&(r=s),-1!==r&&(s===n||!i)){const n=s-(i?0:1),l=this._processRect(t,r,n,o);l&&e.push(l),r=-1}}}return e}_processRect(t,e,n,o){const r=t.length-1;let s=!1,i=!1,l=0;for(let a=o;a<=r;a+=1){for(let o=e;o<=n;o+=1){if(0===t[a][o]){i=!0;break}}if(i)break;for(let o=e;o<=n;o+=1)1===t[a][o]&&(s=!0,t[a][o]=2);l+=1}return s?{x:e,y:o,width:n-e+1,height:l}:null}_getRelativeRects(){const t=this._getRects();if(!t)return null;const e=[],n={};let o=0;return t.forEach((t=>{const e=`${t.width}:${t.height}`;n[e]?(n[e].count+=1,n[e].id||(n[e].id=`i${o.toString(32)}`,o+=1)):n[e]={count:1,rect:t,relative:!1,id:null}})),t.forEach((t=>{const o=`${t.width}:${t.height}`,r=n[o];r.relative?e.push({id:r.id,x:t.x-r.rect.x,y:t.y-r.rect.y}):(r.id&&(t.id=r.id,r.relative=!0),e.push(t))})),e}_buildSVG(t){const e=this.getDataSize(),n=[`<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" shape-rendering="crispEdges" viewBox="0 0 ${e} ${e}"${this.width?` width=${this.width}`:""}${this.height?` height=${this.height}`:""} >`];this.bgColor&&n.push(`<rect x="0" y="0" height="${e}" width="${e}" fill="${this.bgColor}"/>`),t.forEach((t=>{if(t.width&&t.height){const e=t.id?`id="${t.id}" `:"";n.push(`<rect ${e}x="${t.x}" y="${t.y}" height="${t.height}" width="${t.width}" fill="${this.fgColor}"/>`)}else n.push(`<use xlink:href="#${t.id}" x="${t.x}" y="${t.y}"/>`)}));const o=this._getImageConfig();return o&&o.width&&o.height&&n.push(`<image xlink:href="${o.source}" x="${o.x}" y="${o.y}" width="${o.width}" height="${o.height}"/>`),n.push("</svg>"),n.join("")}toString(){if(!this.qrCodeSVG){if(!this.getDataSize())return null;const t=this._getRects();if(!t)return null;this.qrCodeSVG=this._buildSVG(t)}return this.qrCodeSVG}toDataUrl(){if(!this.qrCodeDataUrl){if(!this.getDataSize())return null;const t=this._getRelativeRects();if(!t)return null;const e=this._buildSVG(t);this.qrCodeDataUrl=`data:image/svg+xml;base64,${btoa(e)}`}return this.qrCodeDataUrl}};function lt(t){t&&t.remove()}function at(t,e,n="./assets/boat7.svg"){const o=new URL(t);var r,s;return function(t,e,n){const o=new it(t,{level:"M",padding:3,image:{source:n,width:"20%",height:"15%",x:"center",y:"center"}});var r;return e.innerHTML=o.toString(),(r=e).addEventListener("click",(()=>r.classList.toggle("big"))),e}((r=o.toString(),s="/",r.charAt(r.length-s.length)===s?r.substr(0,r.length-s.length):r),e,n)}function ct(t,e){const n={method:e};return n[e]=t,JSON.stringify(n)}const ut={parser:function(t,e,n){const o=JSON.parse(t),r=o[o.method];return o.method===e&&n(r),r},toMove:function(t){return ct(t,"move")},toField:function(t){return ct(t,"field")},toRestart:function(t){return ct(t,"restart")}};function ht(t,e){if(!t)throw e}function dt(t,e,n){return function(t,e,n,o,r,s){const l=n[t];o[t]=l;const a=i(n,o,t);let c;o[t]=a,c=l?s.querySelector("#ship-template"):s.querySelector("#dot-template2");const u=c.content.cloneNode(!0),d=u.firstElementChild;return l?e?d.classList.add("diagonal-line-enemy"):d.classList.add("diagonal-line"):e&&d.classList.add("enemy"),r.appendChild(u),d.style.left=t*h+"px",d.style.width=h+"px",{html:d,res:l,verdict:a}}(t,e.isOpponentEnemy,e.realField,e.guessedField,e.htmlRiver,n)}const ft=t=>{t&&t.play()},gt=function(t){let e;return e=t?"Сейчас прилетит!":"Ходи!","Игра началась. "+e};function mt(t,e){return t>e?e:t<0?0:t}function pt(t,e,n){const o=n.querySelector(".overlay");n.querySelector(".close").addEventListener("click",(t=>{t.preventDefault(),o.classList.remove("show")}),!1);o.querySelector("h2").textContent=t;o.querySelector(".content").textContent=e,o.classList.add("show")}function yt(t,n,o,r){ht(n.length===o.length,"Bad size");let s="red"===r.color;p(gt(s),70,s,1e5,t);const i=function(t,e){const n={};for(const e of t)n[e]=[];const o=t=>{const e=n[t];return ht(Array.isArray(e),"No key "+t),e},r=(t,n)=>{const r=[];for(const s of o(t))"function"==typeof s&&(e?e.add((()=>s(n))):r.push(s(n)));return Promise.all(r)};return{on:(t,e)=>o(t).push(e),setOnce:(t,e)=>{n[t]=[e]},call:r,handler:t=>e=>r(t,e),reset:t=>{n[t]=[]},actionKeys:()=>Object.keys(n)}}(["playerMove","enemyMove","meMove","aiMove","gameover"]),l=i.on,c=i.handler("aiMove"),u=i.handler("meMove"),d=function(t,e){const n=g(t,e);return n.classList.add("adjust-second"),n.querySelector(".river")}(t.querySelector(".grid"),t),m=t.querySelector(".river"),y=t.getElementById("bloop");function w(e,n){a(e.guessedField,n,(n=>{!function(t,e,n,o){const r=o.querySelector("#dot-template").content.cloneNode(!0),s=r.firstElementChild;n&&s.classList.add("enemy"),e.appendChild(r),s.style.left=t*h+"px",s.style.width=h+"px"}(n,e.htmlRiver,e.isOpponentEnemy,t)})),r.useSound&&!e.isOpponentEnemy&&ft(y)}const v={realField:n,guessedField:new Array(n.length).fill(e.NONE),htmlRiver:m,onOpponentMiss:u,onOpponentHit:c,isOpponentEnemy:!0},C={realField:o,guessedField:new Array(n.length).fill(e.NONE),htmlRiver:d,onOpponentMiss:c,onOpponentHit:u,isOpponentEnemy:!1};function L(n){const o=s?v:C,{verdict:l}=dt(n,o,t),a=function(t,n){return t===e.HIT?"Ранил":t===e.KILL?"Убил":t===e.MISS?"Мимо":t===e.WIN?n?"Потрачено":"Победа":void 0}(l,o.isOpponentEnemy)+"!";p(a,70,o.isOpponentEnemy,1e5,t),l===e.MISS?(s=!s,o.onOpponentMiss(l)):l===e.WIN?o.isOpponentEnemy?(i.call("gameover",!1),pt("Ты проиграл","В другой раз повезет",t)):function(){if(i.call("gameover",!0),r.useSound){const e=t.getElementById("tada");ft(e)}pt("Победа","А ты хорош!",t)}():(o.onOpponentHit(l),l===e.KILL&&w(o,n))}function b(t){s&&(t=mt(t,n.length-1),i.call("enemyMove",t),L(t))}function E(t){s||(t=mt(t,n.length-1),i.call("playerMove",t),L(t))}function S(t){f(t,b)}d.addEventListener("click",(function(t){f(t,E)}));return{size:()=>n.length,fireEnemy:b,firePlayer:E,on:l,enableHotSeat:function(){m.addEventListener("click",S)},isEnemyMove:()=>s}}function wt(t,e,n,o){return e.onOpponentReady(),yt(t,e.field,n,o)}function vt(t){return function(t,e){const n=t+Math.random()*(e-t);return Math.floor(n)}(0,t)}function Ct(t){let n=function(t){let n=0;for(let o=0;o<t.length;o++)t[o]===e.NONE&&++n;return ht(n>0,"No empty space"),vt(n)}(t),o=0;for(;o<t.length&&(t[o]===e.NONE&&--n,!(n<0));o++);return ht(o<t.length&&o>=0,"No empty space2"),o}function Lt(t){const e=[[0,1,0,0,0,1,0,1,1,0,1,0,1,1,0,1,1,1],[0,1,0,0,1,0,1,0,1,1,0,1,1,0,1,1,1,0],[0,0,0,1,0,1,0,1,0,1,1,1,0,1,1,0,1,1],[1,0,1,0,0,0,1,0,0,1,1,0,1,1,1,0,1,1],[1,0,1,0,0,0,1,1,1,0,1,1,0,1,1,0,0,1],[1,1,1,0,1,1,0,1,1,0,1,0,1,0,0,0,0,1]];return t<0&&(t=vt(e.length)),e[t]}function bt(t){const n=new Array(t).fill(e.NONE);let o=-1,r=0,s=-1;function i(t,n){if(o<0)return Ct(t);if(ht(o<t.length,"In bounds"),t[o]=n,n===e.HIT){0===r&&(r=0===vt(2)?-1:1);let e=-1;return l(t,o,r,(t=>{e=t})),e>=0?e:(r*=-1,l(t,o,r,(t=>{e=t})),e>=0?e:Ct(t))}if(n===e.KILL)return a(t,o,(n=>{t[n]=e.IMPOSSIBLE_BY_RULES})),r=0,Ct(t);if(n===e.MISS){if(0!==r){r*=-1;let e=-1;return l(t,o,r,(t=>{e=t})),e>=0?e:(r=0,Ct(t))}return Ct(t)}return Ct(t)}return{guess:function(t){const e=i(n,t);return ht(e>=0&&e<n.length,"In bounds3"),s=e,e},setLastMove:function(t){ht(t>=0&&t<n.length,"In bounds"),o=t}}}const Et=t=>new Promise((e=>setTimeout(e,t)));function St(t,e){let n=-1;for(let o=0;o<t.length;o++)if(1===t[o]&&n<0&&(n=o),0===t[o]){if(n>=0&&o-n===e)return n;n=-1}return t.length-n===e?n:-1}function kt(t,e,n){for(let o=e;o<e+n+1;o++)t[o]=0}function Dt(t,e,n){!function(t,e){let n=0,o=0;t.addEventListener("click",(t=>{if(t.preventDefault(),o>=e.length)return;++n;const{clicks:r,launch:s}=e[o];return n<r?void 0:(++o,s())}))}(t.querySelector(e),n)}function Bt(t){const e=bt(t.size());function n(n){const o=e.guess(n);setTimeout((()=>{t.firePlayer(o)}),700)}return t.on("meMove",n),t.on("playerMove",(t=>{e.setLastMove(t)})),t.isEnemyMove()||n(),t}function Mt(t){return t.getBattle().then(Bt)}function Pt(t){Dt(document,".secret-code",[{clicks:3,launch:()=>{const e=Lt(-1);return async function(t,e){const n=t.ships;for(const o of n){t.choose(o,0),await Et(500);const n=St(e,o.length);t.putShip(n)&&kt(e,n,o.length),await Et(200)}}(t.myField,e)}},{clicks:6,launch:()=>Mt(t)}])}function _t(t,e,n,o){const r=wt(t,e,Lt(-1),n);return o?function(t){const e=bt(t.size());function n(n){const o=e.guess(n);setTimeout((()=>{t.fireEnemy(o)}),700)}t.on("aiMove",n),t.on("enemyMove",(t=>e.setLastMove(t))),t.isEnemyMove()&&n()}(r):r.enableHotSeat(),function(t,e){t.on("gameover",(()=>{const t=e.querySelector(".butInstall");t&&t.classList.remove("hidden2")}))}(r,t),r}function It(t,e,n){const o=new URL(t);o.searchParams.set("color",u(n));const r=e.querySelector(".qrcontainer"),s=e.createElement("div");return s.classList.add("qrcode"),r.appendChild(s),at(o.toString(),s)}const At="black";function Nt(t,e){if(!t)return;const n=t.querySelectorAll("rect[fill='#000']");for(const t of n)t.style.fill=e}function xt(t,e,n,o,r){const s=r.createElement("div");s.classList.add("qrcode"),o.appendChild(s),t.searchParams.set("color",n);const i="red"===n?"./assets/boat4.svg":"./assets/boat7.svg";at(t.toString(),s,i),Nt(s,n),e[n]=s}function qt(t,e,n){const o=Promise.withResolvers();!function(t){t.querySelector(".grid").replaceChildren(),t.querySelector(".message").textContent="",t.querySelector(".overlay").classList.remove("show")}(e);const r=y(e),s=Promise.withResolvers();t.on("recv",(t=>{ut.parser(t,"field",(t=>{s.resolve(t)}))})),r.myFieldPromise.then((r=>{const i=r.field;p("Ждем оппонента",70,!1,1e5,e),t.sendMessage(ut.toField(i)),s.promise.then((s=>{const i=wt(e,r,s,n);i.on("playerMove",(e=>t.sendMessage(ut.toMove(e)))),t.on("recv",(t=>{ut.parser(t,"move",(t=>{i.fireEnemy(t)}))})),i.on("gameover",(()=>{const o=e.querySelector(".secret-code2"),r=o.textContent;o.textContent="🔃";const s=new AbortController,{signal:i}=s;o.classList.add("clickable"),o.addEventListener("click",(i=>{i.preventDefault(),o.textContent=r,o.classList.remove("clickable"),s.abort(),t.sendMessage(ut.toRestart(n.color)),n.color=u(n.color),requestAnimationFrame((()=>qt(t,e,n)))}),{signal:i}),t.on("recv",(i=>{ut.parser(i,"restart",(i=>{o.textContent=r,o.classList.remove("clickable"),s.abort(),n.color=i,requestAnimationFrame((()=>qt(t,e,n)))}))}))})),o.resolve(i)}))}));Pt({myField:r,getBattle:()=>o.promise})}function Tt(t,e,n){const o=n.color,r=w(t.location,n),s=v(t.location,n);let i=null;_.on("socket_open",(()=>{i=function(t,e,n){const o=new URL(t);o.searchParams.set("color",u(n)),o.searchParams.set("mode","match");const r=e.querySelector(".qrcontainer"),s=e.createElement("div");return s.classList.add("qrcode"),r.appendChild(s),at(o.toString(),s)}(s,e,o)})),_.on("socket_error",(t=>{})),_.on("socket_close",(()=>{lt(i)})),_.connect(r,o,u(o),n),_.on("open",(()=>(lt(i),qt(_,e,n))))}function Rt(t,e,n){const o=y(t),r=new Promise((r=>{o.myFieldPromise.then((o=>{const s=_t(t,o,e,n);r(s)}))}));return{myField:o,getBattle:function(){return r}}}function Ot(t,e,n){!function(t,e,n){Dt(e,".secret-code2",[{clicks:3,launch:()=>Mt(n)},{clicks:10,launch:()=>{t.location.href="https://asavan.github.io/"}}])}(t,e,n),Pt(n)}function $t(t,e,n){let o;switch(n.mode){case"ai":o=Rt(e,n,!0),Ot(t,e,o);break;case"net":o=function(t,e,n){const o=n.color;let r=!1;const s=w(t.location,n),i=v(t.location,n);let l=null;const a=Promise.withResolvers(),c=!!s&&!n.showqrfake;if(n.showqrfake&&(l=It(i,e,o)),c){_.on("socket_open",(()=>{l=It(i,e,o)})),_.on("socket_error",(()=>{r=!0})),_.on("socket_close",(()=>{lt(l)}));try{_.connect(s,o,u(o),n)}catch(t){r=!0}_.on("open",(()=>{r=!1})),_.on("recv",(t=>{ut.parser(t,"field",(t=>{a.resolve(t)}))}))}else r=!0;const h=Promise.withResolvers(),d=y(e);return d.myFieldPromise.then((t=>{if(r){lt(l);const o=_t(e,t,n,r);h.resolve(o)}else{const o=t.field;p("Ждем оппонента",70,!1,1e5,e);const r=_.sendMessage(ut.toField(o));a.promise.then((s=>{r||_.sendMessage(ut.toField(o));const i=wt(e,t,s,n);i.on("playerMove",(t=>_.sendMessage(ut.toMove(t)))),_.on("recv",(t=>{ut.parser(t,"move",(t=>{i.fireEnemy(t)}))})),h.resolve(i)}))}})),{myField:d,getBattle:()=>h.promise}}(t,e,n),Ot(t,e,o);break;case"server":o=function(t,e,n){const o=w(t.location,n),r=v(t.location,n),s={};{const t=new URL(r);t.searchParams.delete("mode");const n=e.querySelector(".qrcontainerserver");xt(t,s,"blue",n,e),xt(t,s,"red",n,e)}_.on("socket_open",(()=>{Nt(s.blue,"royalblue")})),_.on("server_message",(t=>{const e=JSON.parse(t);"connected"===e.action?Nt(s[e.from],At):"close"===e.action&&lt(s[e.from])}));try{_.connect(o,At,null,n)}catch(t){}}(t,e,n);break;case"hotseat":o=Rt(e,n,!1),Pt(o);break;case"match":o=Tt(t,e,n)}return o}function Ft(t){switch(t.toLowerCase().trim()){case"true":case"yes":case"1":return!0;case"false":case"no":case"0":case null:return!1;default:return Boolean(t)}}!function(e,n){!function(t,e){const n=new URLSearchParams(t),o=[];for(const[t,r]of n)"number"==typeof e[t]?e[t]=Number.parseInt(r,10):"boolean"==typeof e[t]?e[t]=Ft(r):e[t]=r,o.push(t)}(e.location.search,t),$t(e,n,t)}(window,document)})()})();